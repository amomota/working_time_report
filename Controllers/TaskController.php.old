<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Userproject;
use App\Project;
use App\Role;
use App\Workplace;
use Auth;

class TaskController extends Controller
{
    public function __construct()
    {
        $this->middleware('auth');
    }

    public function index(){

    	$projects = Userproject::where('user_id', Auth::User()->id)
    					->orderBy('start_day', 'desc')
    					->get();
		foreach ($projects as $project) {
			$temp_project = Project::where('id', $project->project_id)->first();
			$temp_role = Role::where('id', $project->role_id)->first();
                        $temp_workplace = Workplace::where('id', $project->workplace_id)->first();
			$project->projname = $temp_project->name;
                        $project->rolename = $temp_role->name;
                        $project->workplacename = $temp_workplace->name;
		}
    	return view('taskslist')->with('projects', $projects);
    }

    public function batchAdd(Request $request) {
        if (Auth::User()->isadmin) {
            return redirect()->to('/admin');
        }
        $projects = Project::all();
        $roles = Role::all();
        $workplaces = Workplace::all();
        $userproject = Userproject::where('user_id', Auth::User()->id)->orderBy('created_at', 'desc')->first();

        return view('batchadd')->with(compact('projects', $projects, 'roles', $roles, 'workplaces', $workplaces, 'userproject', $userproject));
    }

    public function batchSave(Request $request) {

        // dd($request);
        $date = date_create($request->start_range);
        // dd($date->modify('+1 day'));
        for ($i=0; $i < $request->range_days; $i++) { 
            $userproject = new Userproject;

            $userproject->user_id = Auth::User()->id;
            $userproject->project_id = $request->project;
            $userproject->role_id = $request->role;
            $userproject->workplace_id = $request->workplace;
            $userproject->start_day = $date->format('Y-m-d');
            $userproject->start_time = $request->start_time;
            $userproject->finish_time = $request->finish_time;
            $userproject->finish_day = $date->format('Y-m-d');
            $userproject->lunch_time = $request->lunch_time;
            $userproject->duration = $request->duration;
            $userproject->late = 0;
            $userproject->late_reason = '';

            $userproject->save();
            $date->modify('+1 day');
        }
        return redirect()->to('taskslist');
    }
}
